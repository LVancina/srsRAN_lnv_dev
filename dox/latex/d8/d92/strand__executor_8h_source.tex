\doxysection{strand\+\_\+executor.\+h}
\hypertarget{strand__executor_8h_source}{}\label{strand__executor_8h_source}\index{include/srsran/support/executors/strand\_executor.h@{include/srsran/support/executors/strand\_executor.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *\ Copyright\ 2021-\/2024\ Software\ Radio\ Systems\ Limited}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *\ This\ file\ is\ part\ of\ srsRAN.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ srsRAN\ is\ free\ software:\ you\ can\ redistribute\ it\ and/or\ modify}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *\ it\ under\ the\ terms\ of\ the\ GNU\ Affero\ General\ Public\ License\ as}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ published\ by\ the\ Free\ Software\ Foundation,\ either\ version\ 3\ of}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *\ the\ License,\ or\ (at\ your\ option)\ any\ later\ version.}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ *\ srsRAN\ is\ distributed\ in\ the\ hope\ that\ it\ will\ be\ useful,}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ *\ but\ WITHOUT\ ANY\ WARRANTY;\ without\ even\ the\ implied\ warranty\ of}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ *\ MERCHANTABILITY\ or\ FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE.\ \ See\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{\ *\ GNU\ Affero\ General\ Public\ License\ for\ more\ details.}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ *\ A\ copy\ of\ the\ GNU\ Affero\ General\ Public\ License\ can\ be\ found\ in}}
\DoxyCodeLine{00018\ \textcolor{comment}{\ *\ the\ LICENSE\ file\ in\ the\ top-\/level\ directory\ of\ this\ distribution}}
\DoxyCodeLine{00019\ \textcolor{comment}{\ *\ and\ at\ http://www.gnu.org/licenses/.}}
\DoxyCodeLine{00020\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{pragma}\ \textcolor{preprocessor}{once}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{"{}srsran/adt/concurrent\_queue.h"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{"{}srsran/support/executors/task\_executor.h"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{"{}srsran/support/executors/task\_executor\_utils.h"{}}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{namespace}\ \mbox{\hyperlink{namespacesrsran}{srsran}}\ \{}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keyword}{namespace}\ detail\ \{}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{comment}{//\ Specialization\ for\ strand\ with\ multiple\ queues\ of\ different\ priorities.}}
\DoxyCodeLine{00034\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies>}
\DoxyCodeLine{00035\ \textcolor{keyword}{struct}\ \mbox{\hyperlink{structsrsran_1_1detail_1_1strand__queue}{strand\_queue}}\ \{}
\DoxyCodeLine{00036\ \ \ \textcolor{keyword}{explicit}\ strand\_queue(\textcolor{keyword}{const}\ std::array<\textcolor{keywordtype}{unsigned},\ \textcolor{keyword}{sizeof}...(QueuePolicies)>\&\ strand\_queue\_sizes)\ :}
\DoxyCodeLine{00037\ \ \ \ \ queue(strand\_queue\_sizes,\ std::chrono::microseconds\{0\})}
\DoxyCodeLine{00038\ \ \ \{}
\DoxyCodeLine{00039\ \ \ \}}
\DoxyCodeLine{00040\ \ \ \textcolor{keyword}{explicit}\ strand\_queue(span<\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}>\ strand\_queue\_sizes)\ :}
\DoxyCodeLine{00041\ \ \ \ \ queue(}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ [\&strand\_queue\_sizes]()\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{error__handling_8h_af2a19668fa4937d5d6aa2c93f42b7f8a}{report\_error\_if\_not}}(strand\_queue\_sizes.size()\ ==\ \textcolor{keyword}{sizeof}...(QueuePolicies),}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Number\ of\ queue\ sizes\ must\ match\ number\ of\ policies"{}});}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ std::array<\textcolor{keywordtype}{unsigned},\ \textcolor{keyword}{sizeof}...(QueuePolicies)>\ sizes;}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (size\_t\ i\ =\ 0;\ i\ <\ \textcolor{keyword}{sizeof}...(QueuePolicies);\ ++i)\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ sizes[i]\ =\ strand\_queue\_sizes[i];}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ sizes;}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \}(),}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ std::chrono::microseconds\{0\})}
\DoxyCodeLine{00052\ \ \ \{}
\DoxyCodeLine{00053\ \ \ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordtype}{bool}\ try\_push(unique\_task\ task)}
\DoxyCodeLine{00057\ \ \ \{}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordflow}{return}\ queue.\textcolor{keyword}{template}\ try\_push<Priority>(std::move(task));}
\DoxyCodeLine{00059\ \ \ \}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00062\ \ \ \textcolor{keyword}{auto}\ get\_enqueuer()}
\DoxyCodeLine{00063\ \ \ \{}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordflow}{return}\ queue.\textcolor{keyword}{template}\ get\_non\_blocking\_enqueuer<Priority>();}
\DoxyCodeLine{00065\ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ concurrent\_priority\_queue<unique\_task,\ QueuePolicies...>\ queue;}
\DoxyCodeLine{00068\ \};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \textcolor{comment}{//\ Specialization\ for\ strand\ with\ single\ queue.}}
\DoxyCodeLine{00071\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}\ QueuePolicy>}
\DoxyCodeLine{00072\ \textcolor{keyword}{struct}\ \mbox{\hyperlink{structsrsran_1_1detail_1_1strand__queue}{strand\_queue}}<QueuePolicy>\ \{}
\DoxyCodeLine{00073\ \ \ \textcolor{keyword}{explicit}\ strand\_queue(\textcolor{keywordtype}{unsigned}\ strand\_queue\_size)\ :\ queue(strand\_queue\_size)\ \{\}}
\DoxyCodeLine{00074\ \ \ \textcolor{keyword}{explicit}\ strand\_queue(span<\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}>\ strand\_queue\_sizes)\ :}
\DoxyCodeLine{00075\ \ \ \ \ queue([\&strand\_queue\_sizes]()\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \mbox{\hyperlink{error__handling_8h_af2a19668fa4937d5d6aa2c93f42b7f8a}{report\_error\_if\_not}}(strand\_queue\_sizes.size()\ ==\ 1,\ \textcolor{stringliteral}{"{}Number\ of\ queue\ sizes\ must\ match\ number\ of\ policies"{}});}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ strand\_queue\_sizes[0];}
\DoxyCodeLine{00078\ \ \ \ \ \}())}
\DoxyCodeLine{00079\ \ \ \{}
\DoxyCodeLine{00080\ \ \ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordtype}{bool}\ try\_push(unique\_task\ task)}
\DoxyCodeLine{00084\ \ \ \{}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{return}\ queue.try\_push(std::move(task));}
\DoxyCodeLine{00086\ \ \ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00089\ \ \ \textcolor{keyword}{auto}\ get\_enqueuer()}
\DoxyCodeLine{00090\ \ \ \{}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordflow}{return}\ non\_blocking\_enqueuer<unique\_task,\ QueuePolicy>\{queue\};}
\DoxyCodeLine{00092\ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ concurrent\_queue<unique\_task,\ QueuePolicy,\ concurrent\_queue\_wait\_policy::non\_blocking>\ queue;}
\DoxyCodeLine{00095\ \};}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \}\ \textcolor{comment}{//\ namespace\ detail}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \textcolor{comment}{///\ \(\backslash\)brief\ Base\ class\ for\ task\ strand\ implementations.}}
\DoxyCodeLine{00100\ \textcolor{keyword}{class}\ \mbox{\hyperlink{classsrsran_1_1base__task__strand}{base\_task\_strand}}}
\DoxyCodeLine{00101\ \{}
\DoxyCodeLine{00102\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00103\ \ \ \textcolor{keyword}{virtual}\ \string~base\_task\_strand()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{///\ Called\ once\ task\ is\ enqueued\ in\ the\ strand\ queue\ to\ assess\ whether\ the\ strand\ should\ be\ locked\ and\ dispatched.}}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{handle\_enqueued\_task}}(\textcolor{keywordtype}{bool}\ is\_execute)}
\DoxyCodeLine{00107\ \ \ \{}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{comment}{//\ If\ the\ task\_strand\ is\ acquired,\ it\ means\ that\ no\ other\ thread\ is\ running\ the\ pending\ tasks\ and\ we\ need\ to}}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{comment}{//\ dispatch\ a\ job\ to\ run\ them\ to\ the\ wrapped\ executor.}}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keywordtype}{bool}\ strand\_acquired\ =\ job\_count.fetch\_add(1U,\ std::memory\_order\_acq\_rel)\ ==\ 0U;}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ strand\_acquired)\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ failed\ to\ acquire\ the\ task\_strand,\ it\ means\ that\ another\ call\ has\ already\ acquired\ it\ and\ scheduled}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \textcolor{comment}{//\ the\ running\ of\ all\ enqueued\ jobs,\ including\ the\ one\ we\ just\ enqueued\ in\ this\ call.}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00115\ \ \ \ \ \}}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this}-\/>dispatch\_strand(is\_execute);}
\DoxyCodeLine{00117\ \ \ \}}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00120\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ dispatch\_strand(\textcolor{keywordtype}{bool}\ is\_execute)\ =\ 0;}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \textcolor{comment}{//\ Number\ of\ jobs\ currently\ enqueued\ in\ the\ strand.}}
\DoxyCodeLine{00123\ \ \ std::atomic<uint32\_t>\ job\_count\{0\};}
\DoxyCodeLine{00124\ \};}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \textcolor{keyword}{namespace}\ detail\ \{}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}\ QueuePolicy,\ \textcolor{keyword}{typename}\ StrandPtr>}
\DoxyCodeLine{00129\ \textcolor{keyword}{class}\ task\_strand\_executor\_impl\ \textcolor{keyword}{final}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classsrsran_1_1task__executor}{task\_executor}}}
\DoxyCodeLine{00130\ \{}
\DoxyCodeLine{00131\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00132\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ U>}
\DoxyCodeLine{00133\ \ \ task\_strand\_executor\_impl(non\_blocking\_enqueuer<unique\_task,\ QueuePolicy>\ enqueuer\_,\ U\&\&\ strand\_)\ :}
\DoxyCodeLine{00134\ \ \ \ \ enqueuer(enqueuer\_),\ strand(std::forward<U>(strand\_))}
\DoxyCodeLine{00135\ \ \ \{}
\DoxyCodeLine{00136\ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \mbox{\hyperlink{compiler_8h_a84270d7b45f0280051bd27685657e03e}{SRSRAN\_NODISCARD}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__executor__impl_afcd8914f8353ff5cc101199d65bd85ea}{execute}}(unique\_task\ task)\ \textcolor{keyword}{override}}
\DoxyCodeLine{00139\ \ \ \{}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{comment}{//\ Enqueue\ task\ in\ task\_strand\ queue.}}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ enqueuer.try\_push(std::move(task)))\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \textcolor{comment}{//\ strand\ queue\ is\ full.}}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00144\ \ \ \ \ \}}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keywordflow}{return}\ strand-\/>handle\_enqueued\_task(\textcolor{keyword}{true});}
\DoxyCodeLine{00146\ \ \ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \mbox{\hyperlink{compiler_8h_a84270d7b45f0280051bd27685657e03e}{SRSRAN\_NODISCARD}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__executor__impl_a2e5f513c832805401156bf491dcb9cf0}{defer}}(unique\_task\ task)\ \textcolor{keyword}{override}}
\DoxyCodeLine{00149\ \ \ \{}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ Enqueue\ task\ in\ task\_strand\ queue.}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ enqueuer.try\_push(std::move(task)))\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \textcolor{comment}{//\ strand\ queue\ is\ full.}}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00154\ \ \ \ \ \}}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordflow}{return}\ strand-\/>handle\_enqueued\_task(\textcolor{keyword}{false});}
\DoxyCodeLine{00156\ \ \ \}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00159\ \ \ non\_blocking\_enqueuer<unique\_task,\ QueuePolicy>\ enqueuer;}
\DoxyCodeLine{00160\ \ \ StrandPtr\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ strand;}
\DoxyCodeLine{00161\ \};}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies>}
\DoxyCodeLine{00164\ \textcolor{keyword}{class}\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue}{task\_strand\_with\_queue}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classsrsran_1_1base__task__strand}{base\_task\_strand}}}
\DoxyCodeLine{00165\ \{}
\DoxyCodeLine{00166\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00167\ \ \ \textcolor{comment}{///\ Queue\ Policies\ of\ this\ strand.}}
\DoxyCodeLine{00168\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ std::array<\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}},\ \textcolor{keyword}{sizeof}...(QueuePolicies)>\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue_a6c1e75fd1fabcf24d07285a4a5641469}{queue\_policies}}\{QueuePolicies...\};}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \textcolor{comment}{///\ \(\backslash\)brief\ Executor\ with\ a\ compile-\/time\ defined\ task\ priority\ that\ dispatches\ tasks\ to\ the\ associated\ strand.}}
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{///}}
\DoxyCodeLine{00172\ \ \ \textcolor{comment}{///\ This\ executor\ does\ not\ control\ the\ lifetime\ of\ the\ strand.}}
\DoxyCodeLine{00173\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00174\ \ \ \textcolor{keyword}{using}\ executor\ =}
\DoxyCodeLine{00175\ \ \ \ \ \ \ detail::task\_strand\_executor\_impl<get\_priority\_queue\_policy<QueuePolicies...>(Priority),\ \mbox{\hyperlink{classsrsran_1_1base__task__strand}{base\_task\_strand}}*>;}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00178\ \ \ \textcolor{keyword}{explicit}\ task\_strand\_with\_queue(Args\&\&...\ queue\_params)\ :\ queue(std::forward<Args>(queue\_params)...)}
\DoxyCodeLine{00179\ \ \ \{}
\DoxyCodeLine{00180\ \ \ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{comment}{///\ Number\ of\ priority\ levels\ supported\ by\ this\ strand.}}
\DoxyCodeLine{00183\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue_a96180cf36355d1d2cb1b3b7a890eb032}{size\_t}}\ \mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue_a96180cf36355d1d2cb1b3b7a890eb032}{nof\_priority\_levels}}()\ \{\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{sizeof}...(QueuePolicies);\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00186\ \ \ \mbox{\hyperlink{compiler_8h_a84270d7b45f0280051bd27685657e03e}{SRSRAN\_NODISCARD}}\ \textcolor{keywordtype}{bool}\ execute(unique\_task\ task)}
\DoxyCodeLine{00187\ \ \ \{}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{comment}{//\ Enqueue\ task\ in\ task\_strand\ queue.}}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ \textcolor{keyword}{this}-\/>queue.\textcolor{keyword}{template}\ try\_push<Priority>(std::move(task)))\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00191\ \ \ \ \ \}}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{handle\_enqueued\_task}}\mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{(}}\textcolor{keyword}{true}\mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{)}};}
\DoxyCodeLine{00193\ \ \ \}}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00196\ \ \ \mbox{\hyperlink{compiler_8h_a84270d7b45f0280051bd27685657e03e}{SRSRAN\_NODISCARD}}\ \textcolor{keywordtype}{bool}\ defer(unique\_task\ task)}
\DoxyCodeLine{00197\ \ \ \{}
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{comment}{//\ Enqueue\ task\ in\ task\_strand\ queue.}}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ \textcolor{keyword}{this}-\/>queue.\textcolor{keyword}{template}\ try\_push<Priority>(std::move(task)))\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00201\ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{handle\_enqueued\_task}}\mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{(}}\textcolor{keyword}{false}\mbox{\hyperlink{classsrsran_1_1base__task__strand_a8a15b8ead7a27d9a42c97a723f6c4a12}{)}};}
\DoxyCodeLine{00203\ \ \ \}}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority\ =\ \mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}::min>}
\DoxyCodeLine{00206\ \ \ executor<Priority>\ get\_executor()}
\DoxyCodeLine{00207\ \ \ \{}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordflow}{return}\ executor<Priority>\{\textcolor{keyword}{this}-\/>queue.\textcolor{keyword}{template}\ get\_enqueuer(),\ *\textcolor{keyword}{this}\};}
\DoxyCodeLine{00209\ \ \ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ std::unique\_ptr<task\_executor>\ get\_executor\_ptr(enqueue\_priority\ prio)}
\DoxyCodeLine{00212\ \ \ \{}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{return}\ get\_executor\_ptr\_impl(prio,\ std::make\_index\_sequence<\textcolor{keyword}{sizeof}...(QueuePolicies)>\{\});}
\DoxyCodeLine{00214\ \ \ \}}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00217\ \ \ \textcolor{keyword}{auto}\ get\_enqueuer()}
\DoxyCodeLine{00218\ \ \ \{}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this}-\/>queue.\textcolor{keyword}{template}\ get\_enqueuer<Priority>();}
\DoxyCodeLine{00220\ \ \ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00223\ \ \ \textcolor{keyword}{template}\ <size\_t...\ Is>}
\DoxyCodeLine{00224\ \ \ std::unique\_ptr<task\_executor>\ get\_executor\_ptr\_impl(enqueue\_priority\ priority,\ std::index\_sequence<Is...>\ \textcolor{comment}{/*unused*/})}
\DoxyCodeLine{00225\ \ \ \{}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keyword}{const}\ size\_t\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ idx\ =\ detail::enqueue\_priority\_to\_queue\_index(priority,\ \textcolor{keyword}{sizeof}...(QueuePolicies));}
\DoxyCodeLine{00227\ \ \ \ \ std::unique\_ptr<task\_executor>\ exec;}
\DoxyCodeLine{00228\ \ \ \ \ (\textcolor{keywordtype}{void})std::initializer\_list<\textcolor{keywordtype}{int}>\{[\textcolor{keyword}{this},\ idx,\ \&exec]()\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (idx\ ==\ Is)\ \{}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ exec\ =\ std::make\_unique<executor<detail::queue\_index\_to\_enqueue\_priority(Is,\ \textcolor{keyword}{sizeof}...(QueuePolicies))>>(}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{this}-\/>queue.\textcolor{keyword}{template}\ get\_enqueuer(),\ *\textcolor{keyword}{this});}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00234\ \ \ \ \ \}()...\};}
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{keywordflow}{return}\ exec;}
\DoxyCodeLine{00236\ \ \ \}}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \textcolor{comment}{//\ Run\ all\ tasks\ that\ have\ been\ enqueued\ in\ the\ strand,\ and\ unlocks\ the\ strand.}}
\DoxyCodeLine{00239\ \ \ \textcolor{keywordtype}{void}\ run\_enqueued\_tasks()}
\DoxyCodeLine{00240\ \ \ \{}
\DoxyCodeLine{00241\ \ \ \ \ unique\_task\ task;}
\DoxyCodeLine{00242\ \ \ \ \ uint32\_t\ \ \ \ queue\_size\ =\ \textcolor{keyword}{this}-\/>job\_count.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keywordflow}{while}\ (queue\_size\ >\ 0)\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ run\_count\ =\ 0;}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ run\_count\ !=\ queue\_size\ \textcolor{keyword}{and}\ queue.queue.try\_pop(task);\ ++run\_count)\ \{}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ task();}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (run\_count\ !=\ queue\_size)\ \{}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Unexpected\ failure\ to\ pop\ enqueued\ tasks.\ It\ might\ be\ due\ to\ queue\ shutdown.}}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ srslog::fetch\_basic\_logger(\textcolor{stringliteral}{"{}ALL"{}}).info(\textcolor{stringliteral}{"{}Couldn't\ run\ all\ pending\ tasks\ in\ strand"{}});}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ run\ all\ the\ tasks\ that\ were\ enqueued\ since\ when\ we\ computed\ queue\_size.}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \textcolor{comment}{//\ Recompute\ the\ queue\_size\ to\ check\ if\ there\ are\ tasks\ that\ were\ enqueued\ in\ the\ meantime.}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ queue\_size\ =\ \textcolor{keyword}{this}-\/>job\_count.fetch\_sub(run\_count,\ std::memory\_order\_acq\_rel)\ -\/\ run\_count;}
\DoxyCodeLine{00256\ \ \ \ \ \}}
\DoxyCodeLine{00257\ \ \ \}}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \textcolor{keywordtype}{void}\ handle\_failed\_task\_dispatch()}
\DoxyCodeLine{00260\ \ \ \{}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ Pop\ enqueued\ tasks\ until\ number\ of\ enqueued\ jobs\ is\ zero.}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{comment}{//\ Note:\ Since\ we\ acquired\ the\ task\_strand,\ the\ task\ enqueued\ in\ this\ call\ should\ always\ be\ the\ first\ being}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ popped.\ Note:\ If\ there\ is\ a\ single\ producer,\ only\ the\ task\ enqueued\ in\ this\ call\ will\ be\ popped.\ Note:\ As\ we}}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{comment}{//\ currently\ hold\ the\ strand,\ there\ is\ no\ concurrent\ thread\ popping\ tasks.}}
\DoxyCodeLine{00265\ \ \ \ \ uint32\_t\ \ \ \ queue\_size\ =\ \textcolor{keyword}{this}-\/>job\_count.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00266\ \ \ \ \ unique\_task\ dropped\_task;}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{keywordflow}{while}\ (queue\_size\ >\ 0)\ \{}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ run\_count\ =\ 0;}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ run\_count\ !=\ queue\_size\ \textcolor{keyword}{and}\ \textcolor{keyword}{this}-\/>queue.queue.try\_pop(dropped\_task);\ ++run\_count)\ \{}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ do\ nothing\ with\ popped\ task.}}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00272\ \ \ \ \ \ \ queue\_size\ =\ \textcolor{keyword}{this}-\/>job\_count.fetch\_sub(run\_count,\ std::memory\_order\_acq\_rel)\ -\/\ run\_count;}
\DoxyCodeLine{00273\ \ \ \ \ \}}
\DoxyCodeLine{00274\ \ \ \}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \ \ unique\_task\ get\_run\_strand\_task()}
\DoxyCodeLine{00277\ \ \ \{}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{keywordflow}{return}\ [\textcolor{keyword}{this}]()\ \{\ run\_enqueued\_tasks();\ \};}
\DoxyCodeLine{00279\ \ \ \}}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \textcolor{comment}{//\ Queue\ of\ pending\ tasks\ waiting\ for\ their\ turn.}}
\DoxyCodeLine{00282\ \ \ detail::\mbox{\hyperlink{structsrsran_1_1detail_1_1strand__queue}{strand\_queue}}<QueuePolicies...>\ queue;}
\DoxyCodeLine{00283\ \};}
\DoxyCodeLine{00284\ }
\DoxyCodeLine{00285\ \}\ \textcolor{comment}{//\ namespace\ detail}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \textcolor{comment}{///\ \(\backslash\)brief\ This\ class\ implements\ a\ strand\ of\ one\ or\ more\ enqueueing\ policies,\ each\ with\ a\ different\ priority.}}
\DoxyCodeLine{00288\ \textcolor{comment}{///}}
\DoxyCodeLine{00289\ \textcolor{comment}{///\ \(\backslash\)tparam\ Executor\ Executor\ that\ the\ strands\ dispatches\ tasks\ to.}}
\DoxyCodeLine{00290\ \textcolor{comment}{///\ \(\backslash\)tparam\ QueuePolicies\ Enqueueing\ policies\ for\ each\ of\ the\ task\ priority\ levels\ supported\ by\ the\ strand.}}
\DoxyCodeLine{00291\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Executor,\ \mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies>}
\DoxyCodeLine{00292\ \textcolor{keyword}{class}\ task\_strand\ \textcolor{keyword}{final}\ :\ \textcolor{keyword}{public}\ detail::\mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue}{task\_strand\_with\_queue}}<QueuePolicies...>}
\DoxyCodeLine{00293\ \{}
\DoxyCodeLine{00294\ \ \ \textcolor{keyword}{using}\ base\_type\ =\ detail::\mbox{\hyperlink{classsrsran_1_1detail_1_1task__strand__with__queue}{task\_strand\_with\_queue}}<QueuePolicies...>;}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00297\ \ \ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}\ Priority>}
\DoxyCodeLine{00298\ \ \ \textcolor{keyword}{using}\ executor\ =\ \textcolor{keyword}{typename}\ base\_type::\textcolor{keyword}{template}\ executor<Priority>;}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Exec,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00301\ \ \ \textcolor{keyword}{explicit}\ task\_strand(Exec\&\&\ executor\_,\ Args\&\&...\ queue\_params)\ :}
\DoxyCodeLine{00302\ \ \ \ \ base\_type(std::forward<Args>(queue\_params)...),\ out\_exec(std::forward<Exec>(executor\_))}
\DoxyCodeLine{00303\ \ \ \{}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00307\ \ \ \textcolor{keywordtype}{bool}\ dispatch\_strand(\textcolor{keywordtype}{bool}\ is\_execute)\ \textcolor{keyword}{final}}
\DoxyCodeLine{00308\ \ \ \{}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{comment}{//\ Check\ if\ the\ adapted\ executor\ gives\ us\ permission\ to\ run\ pending\ tasks\ inline.\ An\ example\ of\ when\ this\ may}}
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{comment}{//\ happen\ is\ when\ the\ caller\ is\ running\ in\ the\ same\ execution\ context\ of\ the\ underlying\ task\ worker\ or\ task\ worker}}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{comment}{//\ pool.\ However,\ this\ permission\ is\ still\ not\ a\ sufficient\ condition\ to\ simply\ call\ the\ task\ inline.\ For}}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{comment}{//\ instance,\ if\ the\ execution\ context\ is\ a\ thread\ pool,\ we\ have\ to\ ensure\ that\ the\ task\_strand\ is\ not\ already}}
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{comment}{//\ acquired\ by\ another\ thread\ of\ the\ same\ pool.\ If\ we\ do\ not\ do\ this,\ running\ the\ task\ inline\ would\ conflict\ with}}
\DoxyCodeLine{00314\ \ \ \ \ \textcolor{comment}{//\ the\ task\_strand\ strict\ serialization\ requirements.\ For\ this\ reason,\ we\ will\ always\ enqueue\ the\ task\ and\ try\ to}}
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{comment}{//\ acquire\ the\ task\_strand.}}
\DoxyCodeLine{00316\ \ \ \ \ \textcolor{keywordtype}{bool}\ dispatch\_successful;}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_execute)\ \{}
\DoxyCodeLine{00318\ \ \ \ \ \ \ dispatch\_successful\ =\ detail::get\_task\_executor\_ref(out\_exec).execute(\textcolor{keyword}{this}-\/>get\_run\_strand\_task());}
\DoxyCodeLine{00319\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ dispatch\_successful\ =\ detail::get\_task\_executor\_ref(out\_exec).defer(\textcolor{keyword}{this}-\/>get\_run\_strand\_task());}
\DoxyCodeLine{00321\ \ \ \ \ \}}
\DoxyCodeLine{00322\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{not}\ dispatch\_successful)\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \textcolor{comment}{//\ Unable\ to\ dispatch\ executor\ job\ to\ run\ enqueued\ tasks.}}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \textcolor{keyword}{this}-\/>handle\_failed\_task\_dispatch();}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00326\ \ \ \ \ \}}
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00328\ \ \ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \textcolor{comment}{//\ Executor\ to\ which\ tasks\ are\ dispatched\ in\ serialized\ manner.}}
\DoxyCodeLine{00331\ \ \ Executor\ out\_exec;}
\DoxyCodeLine{00332\ \};}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \textcolor{comment}{///\ \(\backslash\)brief\ Creates\ a\ task\ strand\ instance\ given\ a\ list\ of\ parameters}}
\DoxyCodeLine{00335\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}\ QueuePolicy,\ \textcolor{keyword}{typename}\ OutExec>}
\DoxyCodeLine{00336\ \mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{std}}::\mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{unique\_ptr}}<\mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{task\_strand}}<\mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{OutExec}},\ \mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{QueuePolicy}}>>\ \mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{make\_task\_strand\_ptr}}(\mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{OutExec}}\&\&\ \mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{out\_exec}},\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{namespacesrsran_a8dd276390d1ba18b481ef5bf5bb27809}{strand\_queue\_size}})}
\DoxyCodeLine{00337\ \{}
\DoxyCodeLine{00338\ \ \ \textcolor{keywordflow}{return}\ std::make\_unique<task\_strand<OutExec,\ QueuePolicy>>(std::forward<OutExec>(out\_exec),\ strand\_queue\_size);}
\DoxyCodeLine{00339\ \}}
\DoxyCodeLine{00340\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies,\ \textcolor{keyword}{typename}\ OutExec>}
\DoxyCodeLine{00341\ std::unique\_ptr<task\_strand<OutExec,\ QueuePolicies...>>\ make\_task\_strand\_ptr(OutExec\&\&\ \ \ \ \ \ \ \ \ \ \ \ out\_exec,}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ span<\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}>\ strand\_queue\_sizes)}
\DoxyCodeLine{00343\ \{}
\DoxyCodeLine{00344\ \ \ \mbox{\hyperlink{error__handling_8h_af2a19668fa4937d5d6aa2c93f42b7f8a}{report\_error\_if\_not}}(strand\_queue\_sizes.size()\ ==\ \textcolor{keyword}{sizeof}...(QueuePolicies),}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Number\ of\ queue\ sizes\ must\ match\ number\ of\ policies\ (\{\}!=\{\})"{}},}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ strand\_queue\_sizes.size(),}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}...(QueuePolicies));}
\DoxyCodeLine{00348\ \ \ \textcolor{keywordflow}{return}\ std::make\_unique<task\_strand<OutExec,\ QueuePolicies...>>(std::forward<OutExec>(out\_exec),\ strand\_queue\_sizes);}
\DoxyCodeLine{00349\ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \textcolor{comment}{///\ \(\backslash\)brief\ Executor\ with\ a\ compile-\/time\ defined\ task\ priority,\ that\ controls\ the\ lifetime\ of\ the\ associated\ strand.}}
\DoxyCodeLine{00352\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}\ QueuePolicy>}
\DoxyCodeLine{00353\ \textcolor{keyword}{using}\ shared\_strand\_executor\ =\ detail::task\_strand\_executor\_impl<QueuePolicy,\ std::shared\_ptr<\mbox{\hyperlink{classsrsran_1_1base__task__strand}{base\_task\_strand}}>>;}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00355\ \textcolor{comment}{///\ \(\backslash\)brief\ Make\ a\ strand\ executor\ that\ manages\ the\ lifetime\ of\ a\ strand\ with\ a\ single\ queue.}}
\DoxyCodeLine{00356\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}\ QueuePolicy,\ \textcolor{keyword}{typename}\ OutExec>}
\DoxyCodeLine{00357\ \mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{std}}::\mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{unique\_ptr}}<\mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{task\_executor}}>\ \mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{make\_strand\_executor\_ptr}}(\mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{OutExec}}\&\&\ \mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{out\_exec}},\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{namespacesrsran_a3f68f327cab5b905278d0d9af556a407}{queue\_size}})}
\DoxyCodeLine{00358\ \{}
\DoxyCodeLine{00359\ \ \ \textcolor{keyword}{auto}\ strand\ \ \ =\ make\_task\_strand\_ptr<QueuePolicy,\ OutExec>(std::forward<OutExec>(out\_exec),\ queue\_size);}
\DoxyCodeLine{00360\ \ \ \textcolor{keyword}{auto}\ enqueuer\ =\ strand-\/>\textcolor{keyword}{template}\ get\_enqueuer<\mbox{\hyperlink{namespacesrsran_a8773a5775c48bb0867347e2791c954d5}{enqueue\_priority}}::max>();}
\DoxyCodeLine{00361\ }
\DoxyCodeLine{00362\ \ \ \textcolor{keywordflow}{return}\ std::make\_unique<shared\_strand\_executor<QueuePolicy>>(enqueuer,\ std::move(strand));}
\DoxyCodeLine{00363\ \}}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \textcolor{keyword}{namespace}\ detail\ \{}
\DoxyCodeLine{00366\ }
\DoxyCodeLine{00367\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies,\ \textcolor{keyword}{typename}\ OutExec,\ size\_t...\ Is>}
\DoxyCodeLine{00368\ std::vector<std::unique\_ptr<task\_executor>>}
\DoxyCodeLine{00369\ make\_strand\_executor\_ptrs\_helper(std::shared\_ptr<task\_strand<OutExec,\ QueuePolicies...>>\&\ strand\_shared,}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::index\_sequence<Is...>\ \textcolor{comment}{/*unused*/})}
\DoxyCodeLine{00371\ \{}
\DoxyCodeLine{00372\ \ \ std::array<std::unique\_ptr<task\_executor>,\ \textcolor{keyword}{sizeof}...(QueuePolicies)>\ execs\{}
\DoxyCodeLine{00373\ \ \ \ \ \ \ std::make\_unique<shared\_strand\_executor<QueuePolicies>>(}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ strand\_shared-\/>\textcolor{keyword}{template}\ get\_enqueuer<detail::queue\_index\_to\_enqueue\_priority(Is,\ \textcolor{keyword}{sizeof}...(QueuePolicies))>(),}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \ \ strand\_shared)...\};}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ \ \ std::vector<std::unique\_ptr<task\_executor>>\ created\_execs;}
\DoxyCodeLine{00378\ \ \ created\_execs.resize(execs.size());}
\DoxyCodeLine{00379\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ i\ =\ 0;\ i\ !=\ created\_execs.size();\ ++i)\ \{}
\DoxyCodeLine{00380\ \ \ \ \ created\_execs[i]\ =\ std::move(execs[i]);}
\DoxyCodeLine{00381\ \ \ \}}
\DoxyCodeLine{00382\ \ \ \textcolor{keywordflow}{return}\ created\_execs;}
\DoxyCodeLine{00383\ \}}
\DoxyCodeLine{00384\ }
\DoxyCodeLine{00385\ \}\ \textcolor{comment}{//\ namespace\ detail}}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00387\ \textcolor{comment}{///\ \(\backslash\)brief\ Create\ all\ executors\ associated\ with\ a\ given\ strand.\ The\ executors\ will\ manage\ the\ strand\ lifetime\ via}}
\DoxyCodeLine{00388\ \textcolor{comment}{///\ reference\ counting.}}
\DoxyCodeLine{00389\ \textcolor{keyword}{template}\ <\mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies,\ \textcolor{keyword}{typename}\ OutExec>}
\DoxyCodeLine{00390\ \mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{std}}::\mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{vector}}<\mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{std}}::\mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{unique\_ptr}}<\mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{task\_executor}}>>\ \mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{make\_strand\_executor\_ptrs}}(\mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{OutExec}}\&\&\ \mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{out\_exec}},\ \mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{span}}<\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}>\ \mbox{\hyperlink{namespacesrsran_a2dbc1d7f9cce43fdcf1dcdb3c290a99b}{qsizes}})}
\DoxyCodeLine{00391\ \{}
\DoxyCodeLine{00392\ \ \ std::shared\_ptr<task\_strand<OutExec,\ QueuePolicies...>>\ strand\_shared\ =}
\DoxyCodeLine{00393\ \ \ \ \ \ \ make\_task\_strand\_ptr<QueuePolicies...>(std::forward<OutExec>(out\_exec),\ qsizes);}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ \ \ \textcolor{keywordflow}{return}\ detail::make\_strand\_executor\_ptrs\_helper(strand\_shared,\ std::make\_index\_sequence<\textcolor{keyword}{sizeof}...(QueuePolicies)>\{\});}
\DoxyCodeLine{00396\ \}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \textcolor{keyword}{namespace}\ detail\ \{}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \textcolor{keyword}{constexpr}\ size\_t\ MAX\_QUEUES\_PER\_STRAND\ =\ 3;}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \textcolor{comment}{//\ Special\ case\ to\ stop\ recursion\ for\ task\ queue\ policies.}}
\DoxyCodeLine{00403\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ OutExec,}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies,}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \ \ \ \ std::enable\_if\_t<(\textcolor{keyword}{sizeof}...(QueuePolicies)\ >\ MAX\_QUEUES\_PER\_STRAND),\ \textcolor{keywordtype}{int}>\ =\ 0>}
\DoxyCodeLine{00406\ std::vector<std::unique\_ptr<task\_executor>>}
\DoxyCodeLine{00407\ make\_strand\_executors\_iter\_helper(OutExec\&\&\ out\_exec,\ span<\textcolor{keyword}{const}\ concurrent\_queue\_params>\ strand\_queues)}
\DoxyCodeLine{00408\ \{}
\DoxyCodeLine{00409\ \ \ report\_fatal\_error(\textcolor{stringliteral}{"{}Strands\ with\ equal\ or\ more\ than\ \{\}\ queues\ are\ not\ supported"{}},\ MAX\_QUEUES\_PER\_STRAND);}
\DoxyCodeLine{00410\ \ \ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{00411\ \};}
\DoxyCodeLine{00412\ }
\DoxyCodeLine{00413\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ OutExec,}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a08f31ae01c088c535705650443feec0c}{concurrent\_queue\_policy}}...\ QueuePolicies,}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \ \ std::enable\_if\_t<\textcolor{keyword}{sizeof}...(QueuePolicies)\ <=\ MAX\_QUEUES\_PER\_STRAND,\ \textcolor{keywordtype}{int}>\ =\ 0>}
\DoxyCodeLine{00416\ std::vector<std::unique\_ptr<task\_executor>>}
\DoxyCodeLine{00417\ make\_strand\_executors\_iter\_helper(OutExec\&\&\ out\_exec,\ span<\textcolor{keyword}{const}\ concurrent\_queue\_params>\ strand\_queues)}
\DoxyCodeLine{00418\ \{}
\DoxyCodeLine{00419\ \ \ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{static}\ size\_t\ Is\ =\ \textcolor{keyword}{sizeof}...(QueuePolicies);}
\DoxyCodeLine{00420\ \ \ \textcolor{keywordflow}{if}\ (strand\_queues.empty()\ \textcolor{keyword}{or}\ Is\ >\ strand\_queues.size())\ \{}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{00422\ \ \ \}}
\DoxyCodeLine{00423\ \ \ \textcolor{keywordflow}{if}\ (Is\ ==\ strand\_queues.size())\ \{}
\DoxyCodeLine{00424\ \ \ \ \ std::array<\textcolor{keywordtype}{unsigned},\ Is>\ strand\_queue\_sizes;}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ i\ =\ 0;\ i\ !=\ strand\_queues.size();\ ++i)\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \ \ strand\_queue\_sizes[i]\ =\ strand\_queues[i].size;}
\DoxyCodeLine{00427\ \ \ \ \ \}}
\DoxyCodeLine{00428\ \ \ \ \ \textcolor{keywordflow}{return}\ make\_strand\_executor\_ptrs<QueuePolicies...>(std::forward<OutExec>(out\_exec),}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ span<\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}>(strand\_queue\_sizes));}
\DoxyCodeLine{00430\ \ \ \}}
\DoxyCodeLine{00431\ }
\DoxyCodeLine{00432\ \ \ \textcolor{keywordflow}{switch}\ (strand\_queues[Is].policy)\ \{}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{keywordflow}{case}\ concurrent\_queue\_policy::lockfree\_mpmc:\ \{}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ make\_strand\_executors\_iter\_helper<OutExec,\ QueuePolicies...,\ concurrent\_queue\_policy::lockfree\_mpmc>(}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \ \ std::forward<OutExec>(out\_exec),\ strand\_queues);}
\DoxyCodeLine{00436\ \ \ \ \ \}\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{case}\ concurrent\_queue\_policy::lockfree\_spsc:\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ make\_strand\_executors\_iter\_helper<OutExec,\ QueuePolicies...,\ concurrent\_queue\_policy::lockfree\_spsc>(}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ std::forward<OutExec>(out\_exec),\ strand\_queues);}
\DoxyCodeLine{00440\ \ \ \ \ \}\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00441\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00442\ \ \ \ \ \ \ report\_fatal\_error(\textcolor{stringliteral}{"{}Unsupported\ queue\ policy."{}});}
\DoxyCodeLine{00443\ \ \ \}}
\DoxyCodeLine{00444\ \ \ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{00445\ \}}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \}\ \textcolor{comment}{//\ namespace\ detail}}
\DoxyCodeLine{00448\ }
\DoxyCodeLine{00449\ \textcolor{comment}{///\ \(\backslash\)brief\ Creates\ a\ list\ of\ task\ executors\ associated\ with\ a\ strand\ that\ points\ to\ the\ provided\ out\ executor.}}
\DoxyCodeLine{00450\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ OutExec>}
\DoxyCodeLine{00451\ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{std}}::\mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{vector}}<\mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{std}}::\mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{unique\_ptr}}<\mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{task\_executor}}>>\ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{make\_strand\_executor\_ptrs}}(\mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{OutExec}}\&\&\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{out\_exec}},}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{span}}<\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{concurrent\_queue\_params}}>\ \mbox{\hyperlink{namespacesrsran_a9ea37a5502f7cb2497f0b53ec9f648f6}{strand\_queues}})}
\DoxyCodeLine{00453\ \{}
\DoxyCodeLine{00454\ \ \ \textcolor{keywordflow}{return}\ detail::make\_strand\_executors\_iter\_helper<OutExec>(std::forward<OutExec>(out\_exec),\ strand\_queues);}
\DoxyCodeLine{00455\ \}}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ \}\ \textcolor{comment}{//\ namespace\ srsran}}

\end{DoxyCode}
