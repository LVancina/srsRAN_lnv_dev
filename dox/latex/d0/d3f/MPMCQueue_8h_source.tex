\doxysection{MPMCQueue.\+h}
\hypertarget{MPMCQueue_8h_source}{}\label{MPMCQueue_8h_source}\index{external/rigtorp/MPMCQueue.h@{external/rigtorp/MPMCQueue.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{Copyright\ (c)\ 2020\ Erik\ Rigtorp\ <erik@rigtorp.se>}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{Permission\ is\ hereby\ granted,\ free\ of\ charge,\ to\ any\ person\ obtaining\ a\ copy}}
\DoxyCodeLine{00005\ \textcolor{comment}{of\ this\ software\ and\ associated\ documentation\ files\ (the\ "{}Software"{}),\ to\ deal}}
\DoxyCodeLine{00006\ \textcolor{comment}{in\ the\ Software\ without\ restriction,\ including\ without\ limitation\ the\ rights}}
\DoxyCodeLine{00007\ \textcolor{comment}{to\ use,\ copy,\ modify,\ merge,\ publish,\ distribute,\ sublicense,\ and/or\ sell}}
\DoxyCodeLine{00008\ \textcolor{comment}{copies\ of\ the\ Software,\ and\ to\ permit\ persons\ to\ whom\ the\ Software\ is}}
\DoxyCodeLine{00009\ \textcolor{comment}{furnished\ to\ do\ so,\ subject\ to\ the\ following\ conditions:}}
\DoxyCodeLine{00010\ \textcolor{comment}{}}
\DoxyCodeLine{00011\ \textcolor{comment}{The\ above\ copyright\ notice\ and\ this\ permission\ notice\ shall\ be\ included\ in\ all}}
\DoxyCodeLine{00012\ \textcolor{comment}{copies\ or\ substantial\ portions\ of\ the\ Software.}}
\DoxyCodeLine{00013\ \textcolor{comment}{}}
\DoxyCodeLine{00014\ \textcolor{comment}{THE\ SOFTWARE\ IS\ PROVIDED\ "{}AS\ IS"{},\ WITHOUT\ WARRANTY\ OF\ ANY\ KIND,\ EXPRESS\ OR}}
\DoxyCodeLine{00015\ \textcolor{comment}{IMPLIED,\ INCLUDING\ BUT\ NOT\ LIMITED\ TO\ THE\ WARRANTIES\ OF\ MERCHANTABILITY,}}
\DoxyCodeLine{00016\ \textcolor{comment}{FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE\ AND\ NONINFRINGEMENT.\ IN\ NO\ EVENT\ SHALL\ THE}}
\DoxyCodeLine{00017\ \textcolor{comment}{AUTHORS\ OR\ COPYRIGHT\ HOLDERS\ BE\ LIABLE\ FOR\ ANY\ CLAIM,\ DAMAGES\ OR\ OTHER}}
\DoxyCodeLine{00018\ \textcolor{comment}{LIABILITY,\ WHETHER\ IN\ AN\ ACTION\ OF\ CONTRACT,\ TORT\ OR\ OTHERWISE,\ ARISING\ FROM,}}
\DoxyCodeLine{00019\ \textcolor{comment}{OUT\ OF\ OR\ IN\ CONNECTION\ WITH\ THE\ SOFTWARE\ OR\ THE\ USE\ OR\ OTHER\ DEALINGS\ IN\ THE}}
\DoxyCodeLine{00020\ \textcolor{comment}{SOFTWARE.}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{pragma}\ \textcolor{preprocessor}{once}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{atomic}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{cassert}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{cstddef}\textcolor{preprocessor}{>}\ \textcolor{comment}{//\ offsetof}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{limits}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{memory}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{keyword}{new}\textcolor{preprocessor}{>}\ \textcolor{comment}{//\ std::hardware\_destructive\_interference\_size}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdexcept}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{ifndef}\ \textcolor{preprocessor}{\_\_cpp\_aligned\_new}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{ifdef}\ \textcolor{preprocessor}{\_WIN32}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{malloc}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}\ \textcolor{comment}{//\ \_aligned\_malloc}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include}\ \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}\ \textcolor{comment}{//\ posix\_memalign}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \textcolor{keyword}{namespace}\ rigtorp\ \{}
\DoxyCodeLine{00042\ \textcolor{keyword}{namespace}\ mpmc\ \{}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{if}\ \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_cpp\_lib\_hardware\_interference\_size}\textcolor{preprocessor}{)}\ \textcolor{preprocessor}{\&\&}\ \textcolor{preprocessor}{!}\textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_APPLE\_\_}\textcolor{preprocessor}{)}}
\DoxyCodeLine{00044\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ size\_t\ hardwareInterferenceSize\ =}
\DoxyCodeLine{00045\ \ \ \ \ std::hardware\_destructive\_interference\_size;}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00047\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ size\_t\ hardwareInterferenceSize\ =\ 64;}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{if}\ \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_cpp\_aligned\_new}\textcolor{preprocessor}{)}}
\DoxyCodeLine{00051\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>\ \textcolor{keyword}{using}\ AlignedAllocator\ =\ std::allocator<T>;}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00053\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>\ \textcolor{keyword}{struct}\ \mbox{\hyperlink{structrigtorp_1_1mpmc_1_1AlignedAllocator}{AlignedAllocator}}\ \{}
\DoxyCodeLine{00054\ \ \ \textcolor{keyword}{using}\ value\_type\ =\ T;}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ T\ *allocate(std::size\_t\ n)\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{keywordflow}{if}\ (n\ >\ std::numeric\_limits<std::size\_t>::max()\ /\ \textcolor{keyword}{sizeof}(T))\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::bad\_array\_new\_length();}
\DoxyCodeLine{00059\ \ \ \ \ \}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{ifdef}\ \textcolor{preprocessor}{\_WIN32}}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keyword}{auto}\ *p\ =\ \textcolor{keyword}{static\_cast}<T\ *>(\_aligned\_malloc(\textcolor{keyword}{sizeof}(T)\ *\ n,\ \textcolor{keyword}{alignof}(T)));}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{if}\ (p\ ==\ \textcolor{keywordtype}{nullptr})\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::bad\_alloc();}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00066\ \ \ \ \ T\ *p;}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordflow}{if}\ (posix\_memalign(\textcolor{keyword}{reinterpret\_cast}<\textcolor{keywordtype}{void}\ **>(\&p),\ \textcolor{keyword}{alignof}(T),}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(T)\ *\ n)\ !=\ 0)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::bad\_alloc();}
\DoxyCodeLine{00070\ \ \ \ \ \}}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordflow}{return}\ p;}
\DoxyCodeLine{00073\ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{keywordtype}{void}\ deallocate(T\ *p,\ std::size\_t)\ \{}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{ifdef}\ \textcolor{preprocessor}{\_WIN32}}
\DoxyCodeLine{00077\ \ \ \ \ \_aligned\_free(p);}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00079\ \ \ \ \ free(p);}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00081\ \ \ \}}
\DoxyCodeLine{00082\ \};}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>\ \textcolor{keyword}{struct}\ \mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{Slot}}\ \{}
\DoxyCodeLine{00086\ \ \ \string~Slot()\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordflow}{if}\ (turn\ \&\ 1)\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ destroy();}
\DoxyCodeLine{00089\ \ \ \ \ \}}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}...\ Args>\ \textcolor{keywordtype}{void}\ construct(Args\ \&\&...args)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_constructible<T,\ Args\ \&\&...>::value,}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ constructible\ with\ Args\&\&..."{}});}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{new}\ (\&storage)\ T(std::forward<Args>(args)...);}
\DoxyCodeLine{00096\ \ \ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \textcolor{keywordtype}{void}\ destroy()\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_destructible<T>::value,}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ destructible"{}});}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keyword}{reinterpret\_cast}<T\ *>(\&storage)-\/>\string~T();}
\DoxyCodeLine{00102\ \ \ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ T\ \&\&move()\ \textcolor{keyword}{noexcept}\ \{\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{reinterpret\_cast}<T\ \&\&>(storage);\ \}}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//\ Align\ to\ avoid\ false\ sharing\ between\ adjacent\ slots}}
\DoxyCodeLine{00107\ \ \ \textcolor{keyword}{alignas}(\mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{hardwareInterferenceSize}})\ std::atomic<size\_t>\ turn\ =\ \{0\};}
\DoxyCodeLine{00108\ \ \ \textcolor{keyword}{typename}\ std::aligned\_storage<\textcolor{keyword}{sizeof}(T),\ \textcolor{keyword}{alignof}(T)>::type\ storage;}
\DoxyCodeLine{00109\ \};}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T,\ \textcolor{keyword}{typename}\ Allocator\ =\ \mbox{\hyperlink{structrigtorp_1_1mpmc_1_1AlignedAllocator}{AlignedAllocator}}<\mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{Slot}}<T>>>}
\DoxyCodeLine{00112\ \textcolor{keyword}{class}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Queue}}\ \{}
\DoxyCodeLine{00113\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00114\ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_copy\_assignable<T>::value\ ||}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::is\_nothrow\_move\_assignable<T>::value,}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ copy\ or\ move\ assignable"{}});}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_destructible<T>::value,}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ destructible"{}});}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00122\ \ \ \textcolor{keyword}{explicit}\ Queue(\textcolor{keyword}{const}\ size\_t\ capacity,}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ Allocator\ \&allocator\ =\ Allocator())}
\DoxyCodeLine{00124\ \ \ \ \ \ \ :\ capacity\_(capacity),\ allocator\_(allocator),\ head\_(0),\ tail\_(0)\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordflow}{if}\ (capacity\_\ <\ 1)\ \{}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::invalid\_argument(\textcolor{stringliteral}{"{}capacity\ <\ 1"{}});}
\DoxyCodeLine{00127\ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{comment}{//\ Allocate\ one\ extra\ slot\ to\ prevent\ false\ sharing\ on\ the\ last\ slot}}
\DoxyCodeLine{00129\ \ \ \ \ slots\_\ =\ allocator\_.allocate(capacity\_\ +\ 1);}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{comment}{//\ Allocators\ are\ not\ required\ to\ honor\ alignment\ for\ over-\/aligned\ types}}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{comment}{//\ (see\ http://eel.is/c++draft/allocator.requirements\#10)\ so\ we\ verify}}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{comment}{//\ alignment\ here}}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{reinterpret\_cast}<size\_t>(slots\_)\ \%\ \textcolor{keyword}{alignof}(\mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{Slot}}<T>)\ !=\ 0)\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ allocator\_.deallocate(slots\_,\ capacity\_\ +\ 1);}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::bad\_alloc();}
\DoxyCodeLine{00136\ \ \ \ \ \}}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{for}\ (size\_t\ i\ =\ 0;\ i\ <\ capacity\_;\ ++i)\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \textcolor{keyword}{new}\ (\&slots\_[i])\ Slot<T>();}
\DoxyCodeLine{00139\ \ \ \ \ \}}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keyword}{static\_assert}(}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \textcolor{keyword}{alignof}(Slot<T>)\ ==\ hardwareInterferenceSize,}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Slot\ must\ be\ aligned\ to\ cache\ line\ boundary\ to\ prevent\ false\ sharing"{}});}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keyword}{static\_assert}(\textcolor{keyword}{sizeof}(Slot<T>)\ \%\ hardwareInterferenceSize\ ==\ 0,}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Slot\ size\ must\ be\ a\ multiple\ of\ cache\ line\ size\ to\ prevent\ "{}}}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}false\ sharing\ between\ adjacent\ slots"{}});}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keyword}{static\_assert}(\textcolor{keyword}{sizeof}(Queue)\ \%\ hardwareInterferenceSize\ ==\ 0,}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Queue\ size\ must\ be\ a\ multiple\ of\ cache\ line\ size\ to\ "{}}}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}prevent\ false\ sharing\ between\ adjacent\ queues"{}});}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keyword}{static\_assert}(}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ offsetof(Queue,\ tail\_)\ -\/\ offsetof(Queue,\ head\_)\ ==}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_cast}<std::ptrdiff\_t>(hardwareInterferenceSize),}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}head\ and\ tail\ must\ be\ a\ cache\ line\ apart\ to\ prevent\ false\ sharing"{}});}
\DoxyCodeLine{00153\ \ \ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \string~Queue()\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{for}\ (size\_t\ i\ =\ 0;\ i\ <\ capacity\_;\ ++i)\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ slots\_[i].\string~Slot();}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ allocator\_.deallocate(slots\_,\ capacity\_\ +\ 1);}
\DoxyCodeLine{00160\ \ \ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \textcolor{comment}{//\ non-\/copyable\ and\ non-\/movable}}
\DoxyCodeLine{00163\ \ \ Queue(\textcolor{keyword}{const}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Queue}}\ \&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00164\ \ \ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Queue}}\ \&operator=(\textcolor{keyword}{const}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Queue}}\ \&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}...\ Args>\ \textcolor{keywordtype}{void}\ emplace(Args\ \&\&...args)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_constructible<T,\ Args\ \&\&...>::value,}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ constructible\ with\ Args\&\&..."{}});}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keyword}{const}\ head\ =\ head\_.fetch\_add(1);}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keyword}{auto}\ \&slot\ =\ slots\_[idx(head)];}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordflow}{while}\ (turn(head)\ *\ 2\ !=\ slot.turn.load(std::memory\_order\_acquire))}
\DoxyCodeLine{00172\ \ \ \ \ \ \ ;}
\DoxyCodeLine{00173\ \ \ \ \ slot.construct(std::forward<Args>(args)...);}
\DoxyCodeLine{00174\ \ \ \ \ slot.turn.store(turn(head)\ *\ 2\ +\ 1,\ std::memory\_order\_release);}
\DoxyCodeLine{00175\ \ \ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}...\ Args>\ \textcolor{keywordtype}{bool}\ try\_emplace(Args\ \&\&...args)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_constructible<T,\ Args\ \&\&...>::value,}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ constructible\ with\ Args\&\&..."{}});}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keyword}{auto}\ head\ =\ head\_.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordflow}{for}\ (;;)\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \&slot\ =\ slots\_[idx(head)];}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (turn(head)\ *\ 2\ ==\ slot.turn.load(std::memory\_order\_acquire))\ \{}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (head\_.compare\_exchange\_strong(head,\ head\ +\ 1))\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ slot.construct(std::forward<Args>(args)...);}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ slot.turn.store(turn(head)\ *\ 2\ +\ 1,\ std::memory\_order\_release);}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keyword}{const}\ prevHead\ =\ head;}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ head\ =\ head\_.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (head\ ==\ prevHead)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00196\ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keywordtype}{void}\ push(\textcolor{keyword}{const}\ T\ \&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_copy\_constructible<T>::value,}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ copy\ constructible"{}});}
\DoxyCodeLine{00202\ \ \ \ \ emplace(v);}
\DoxyCodeLine{00203\ \ \ \}}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ P,}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ =\ \textcolor{keyword}{typename}\ std::enable\_if<}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::is\_nothrow\_constructible<T,\ P\ \&\&>::value>::type>}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordtype}{void}\ push(P\ \&\&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00209\ \ \ \ \ emplace(std::forward<P>(v));}
\DoxyCodeLine{00210\ \ \ \}}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \ \ \textcolor{keywordtype}{bool}\ try\_push(\textcolor{keyword}{const}\ T\ \&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_nothrow\_copy\_constructible<T>::value,}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}T\ must\ be\ nothrow\ copy\ constructible"{}});}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{keywordflow}{return}\ try\_emplace(v);}
\DoxyCodeLine{00216\ \ \ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ P,}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ =\ \textcolor{keyword}{typename}\ std::enable\_if<}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::is\_nothrow\_constructible<T,\ P\ \&\&>::value>::type>}
\DoxyCodeLine{00221\ \ \ \textcolor{keywordtype}{bool}\ try\_push(P\ \&\&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{keywordflow}{return}\ try\_emplace(std::forward<P>(v));}
\DoxyCodeLine{00223\ \ \ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \textcolor{keywordtype}{void}\ pop(T\ \&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keyword}{const}\ tail\ =\ tail\_.fetch\_add(1);}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keyword}{auto}\ \&slot\ =\ slots\_[idx(tail)];}
\DoxyCodeLine{00228\ \ \ \ \ \textcolor{keywordflow}{while}\ (turn(tail)\ *\ 2\ +\ 1\ !=\ slot.turn.load(std::memory\_order\_acquire))}
\DoxyCodeLine{00229\ \ \ \ \ \ \ ;}
\DoxyCodeLine{00230\ \ \ \ \ v\ =\ slot.move();}
\DoxyCodeLine{00231\ \ \ \ \ slot.destroy();}
\DoxyCodeLine{00232\ \ \ \ \ slot.turn.store(turn(tail)\ *\ 2\ +\ 2,\ std::memory\_order\_release);}
\DoxyCodeLine{00233\ \ \ \}}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ \textcolor{keywordtype}{bool}\ try\_pop(T\ \&v)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \textcolor{keyword}{auto}\ tail\ =\ tail\_.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordflow}{for}\ (;;)\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \&slot\ =\ slots\_[idx(tail)];}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (turn(tail)\ *\ 2\ +\ 1\ ==\ slot.turn.load(std::memory\_order\_acquire))\ \{}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tail\_.compare\_exchange\_strong(tail,\ tail\ +\ 1))\ \{}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ v\ =\ slot.move();}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ slot.destroy();}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ slot.turn.store(turn(tail)\ *\ 2\ +\ 2,\ std::memory\_order\_release);}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keyword}{const}\ prevTail\ =\ tail;}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ tail\ =\ tail\_.load(std::memory\_order\_acquire);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tail\ ==\ prevTail)\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00253\ \ \ \ \ \}}
\DoxyCodeLine{00254\ \ \ \}}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \textcolor{comment}{///\ Returns\ the\ number\ of\ elements\ in\ the\ queue.}}
\DoxyCodeLine{00257\ \ \ \textcolor{comment}{///\ The\ size\ can\ be\ negative\ when\ the\ queue\ is\ empty\ and\ there\ is\ at\ least\ one}}
\DoxyCodeLine{00258\ \ \ \textcolor{comment}{///\ reader\ waiting.\ Since\ this\ is\ a\ concurrent\ queue\ the\ size\ is\ only\ a\ best}}
\DoxyCodeLine{00259\ \ \ \textcolor{comment}{///\ effort\ guess\ until\ all\ reader\ and\ writer\ threads\ have\ been\ joined.}}
\DoxyCodeLine{00260\ \ \ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue_a455949764266793f72855b812b19d4a6}{ptrdiff\_t}}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue_a455949764266793f72855b812b19d4a6}{size}}()\ \textcolor{keyword}{const}\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ TODO:\ How\ can\ we\ deal\ with\ wrapped\ queue\ on\ 32bit?}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{static\_cast}<ptrdiff\_t>(head\_.load(std::memory\_order\_relaxed)\ -\/}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tail\_.load(std::memory\_order\_relaxed));}
\DoxyCodeLine{00264\ \ \ \}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \textcolor{comment}{///\ Returns\ true\ if\ the\ queue\ is\ empty.}}
\DoxyCodeLine{00267\ \ \ \textcolor{comment}{///\ Since\ this\ is\ a\ concurrent\ queue\ this\ is\ only\ a\ best\ effort\ guess}}
\DoxyCodeLine{00268\ \ \ \textcolor{comment}{///\ until\ all\ reader\ and\ writer\ threads\ have\ been\ joined.}}
\DoxyCodeLine{00269\ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue_a75d00c5933bc67796b33dc9b916cdb91}{empty}}()\ \textcolor{keyword}{const}\ \textcolor{keyword}{noexcept}\ \{\ \textcolor{keywordflow}{return}\ size()\ <=\ 0;\ \}}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ size\_t\ capacity()\ \textcolor{keyword}{const}\ \textcolor{keyword}{noexcept}\ \{\ \textcolor{keywordflow}{return}\ capacity\_;\ \}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00274\ \ \ \textcolor{keyword}{constexpr}\ size\_t\ idx(size\_t\ i)\ \textcolor{keyword}{const}\ \textcolor{keyword}{noexcept}\ \{\ \textcolor{keywordflow}{return}\ i\ \%\ capacity\_;\ \}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \ \ \textcolor{keyword}{constexpr}\ size\_t\ turn(size\_t\ i)\ \textcolor{keyword}{const}\ \textcolor{keyword}{noexcept}\ \{\ \textcolor{keywordflow}{return}\ i\ /\ capacity\_;\ \}}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00279\ \ \ \textcolor{keyword}{const}\ size\_t\ capacity\_;}
\DoxyCodeLine{00280\ \ \ \mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{Slot}}<T>\ *slots\_;}
\DoxyCodeLine{00281\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{if}\ \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_\_has\_cpp\_attribute\textcolor{preprocessor}{)}\ \textcolor{preprocessor}{\&\&}\ \_\_has\_cpp\_attribute\textcolor{preprocessor}{(}\textcolor{preprocessor}{no\_unique\_address}\textcolor{preprocessor}{)}}
\DoxyCodeLine{00282\ \ \ Allocator\ allocator\_\ [[no\_unique\_address]];}
\DoxyCodeLine{00283\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{else}}
\DoxyCodeLine{00284\ \ \ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Allocator}}\ \mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{allocator\_}};}
\DoxyCodeLine{00285\ \textcolor{preprocessor}{\#}\textcolor{preprocessor}{endif}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \textcolor{comment}{//\ Align\ to\ avoid\ false\ sharing\ between\ head\_\ and\ tail\_}}
\DoxyCodeLine{00288\ \ \ \textcolor{keyword}{alignas}(\mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{hardwareInterferenceSize}})\ std::atomic<size\_t>\ head\_;}
\DoxyCodeLine{00289\ \ \ \textcolor{keyword}{alignas}(\mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{hardwareInterferenceSize}})\ std::atomic<size\_t>\ tail\_;}
\DoxyCodeLine{00290\ \};}
\DoxyCodeLine{00291\ \}\ \textcolor{comment}{//\ namespace\ mpmc}}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T,}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Allocator\ =\ mpmc::\mbox{\hyperlink{structrigtorp_1_1mpmc_1_1AlignedAllocator}{AlignedAllocator}}<mpmc::\mbox{\hyperlink{structrigtorp_1_1mpmc_1_1Slot}{Slot}}<T>>>}
\DoxyCodeLine{00295\ \textcolor{keyword}{using}\ MPMCQueue\ =\ mpmc::\mbox{\hyperlink{classrigtorp_1_1mpmc_1_1Queue}{Queue}}<T,\ Allocator>;}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \}\ \textcolor{comment}{//\ namespace\ rigtorp}}

\end{DoxyCode}
