\doxysection{srsran\+::uci\+\_\+allocator\+\_\+impl Class Reference}
\hypertarget{classsrsran_1_1uci__allocator__impl}{}\label{classsrsran_1_1uci__allocator__impl}\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}


Implementation of \doxylink{classsrsran_1_1uci__allocator}{uci\+\_\+allocator} interface.  




{\ttfamily \#include $<$uci\+\_\+allocator\+\_\+impl.\+h$>$}



Inheritance diagram for srsran\+::uci\+\_\+allocator\+\_\+impl\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=248pt]{d9/dcf/classsrsran_1_1uci__allocator__impl__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for srsran\+::uci\+\_\+allocator\+\_\+impl\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=248pt]{d4/d1f/classsrsran_1_1uci__allocator__impl__coll__graph}
\end{center}
\end{figure}
\doxysubsubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a016335457f6dd1ad6e81c03f0e603d91}{uci\+\_\+allocator\+\_\+impl}} (\mbox{\hyperlink{classsrsran_1_1pucch__allocator}{pucch\+\_\+allocator}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\+\_\+alloc\+\_\+}})
\item 
\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a84eb829ee60066ebf2e38f13386e45c8}{slot\+\_\+indication}} (\mbox{\hyperlink{classsrsran_1_1slot__point}{slot\+\_\+point}} sl\+\_\+tx) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\begin{DoxyCompactList}\small\item\em Reset the internal counter of the allocated PDSCHs to be acknowledged per slot. \end{DoxyCompactList}\item 
\mbox{\hyperlink{classsrsran_1_1optional}{optional}}$<$ \mbox{\hyperlink{structsrsran_1_1uci__allocation}{uci\+\_\+allocation}} $>$ \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_acd2cfbdf8a259b7a56d61acd258dabc2}{alloc\+\_\+uci\+\_\+harq\+\_\+ue}} (\mbox{\hyperlink{structsrsran_1_1cell__resource__allocator}{cell\+\_\+resource\+\_\+allocator}} \&res\+\_\+alloc, \mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}} crnti, \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&ue\+\_\+cell\+\_\+cfg, \mbox{\hyperlink{classunsigned}{unsigned}} k0, \mbox{\hyperlink{classsrsran_1_1span}{span}}$<$ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classuint8__t}{uint8\+\_\+t}} $>$ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\+\_\+list}}, \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{structsrsran_1_1pdcch__dl__information}{pdcch\+\_\+dl\+\_\+information}} \texorpdfstring{$\ast$}{*}\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{fallback\+\_\+dci\+\_\+info}}=\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{nullptr}}) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\item 
\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a4fddfb180ae008720176729b6d33e862}{multiplex\+\_\+uci\+\_\+on\+\_\+pusch}} (\mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\+\_\+sched\+\_\+info}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pusch\+\_\+grant}}, \mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\+\_\+alloc}}, \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&ue\+\_\+cell\+\_\+cfg, \mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}} crnti) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\item 
\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_adc49dd1f1e934b61b239929608850414}{uci\+\_\+allocate\+\_\+sr\+\_\+opportunity}} (\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\+\_\+alloc}}, \mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}} crnti, \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&ue\+\_\+cell\+\_\+cfg) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\item 
\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a8822e6aa48eadc564e20f040e34e21dd}{uci\+\_\+allocate\+\_\+csi\+\_\+opportunity}} (\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\+\_\+alloc}}, \mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}} crnti, \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&ue\+\_\+cell\+\_\+cfg) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\item 
\mbox{\hyperlink{classuint8__t}{uint8\+\_\+t}} \mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a16dcd0eedda8fe1a34f419b1bec7c2f6}{get\+\_\+scheduled\+\_\+pdsch\+\_\+counter\+\_\+in\+\_\+ue\+\_\+uci}} (\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\+\_\+alloc}}, \mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}} crnti) \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{override}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Implementation of \doxylink{classsrsran_1_1uci__allocator}{uci\+\_\+allocator} interface. 

\doxysubsection{Constructor \& Destructor Documentation}
\Hypertarget{classsrsran_1_1uci__allocator__impl_a016335457f6dd1ad6e81c03f0e603d91}\label{classsrsran_1_1uci__allocator__impl_a016335457f6dd1ad6e81c03f0e603d91} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!uci\_allocator\_impl@{uci\_allocator\_impl}}
\index{uci\_allocator\_impl@{uci\_allocator\_impl}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{uci\_allocator\_impl()}{uci\_allocator\_impl()}}
{\footnotesize\ttfamily uci\+\_\+allocator\+\_\+impl\+::uci\+\_\+allocator\+\_\+impl (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classsrsran_1_1pucch__allocator}{pucch\+\_\+allocator}} \&}]{pucch\+\_\+alloc\+\_\+ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [explicit]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :}
\DoxyCodeLine{00036\ \ \ pucch\_alloc\{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_alloc\_}}\},\ logger(srslog::fetch\_basic\_logger(\textcolor{stringliteral}{"{}SCHED"{}}))}
\DoxyCodeLine{00037\ \{}
\DoxyCodeLine{00038\ \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\Hypertarget{classsrsran_1_1uci__allocator__impl_acd2cfbdf8a259b7a56d61acd258dabc2}\label{classsrsran_1_1uci__allocator__impl_acd2cfbdf8a259b7a56d61acd258dabc2} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!alloc\_uci\_harq\_ue@{alloc\_uci\_harq\_ue}}
\index{alloc\_uci\_harq\_ue@{alloc\_uci\_harq\_ue}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{alloc\_uci\_harq\_ue()}{alloc\_uci\_harq\_ue()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classsrsran_1_1optional}{optional}}$<$ \mbox{\hyperlink{structsrsran_1_1uci__allocation}{uci\+\_\+allocation}} $>$ uci\+\_\+allocator\+\_\+impl\+::alloc\+\_\+uci\+\_\+harq\+\_\+ue (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structsrsran_1_1cell__resource__allocator}{cell\+\_\+resource\+\_\+allocator}} \&}]{res\+\_\+alloc,  }\item[{\mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}}}]{crnti,  }\item[{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&}]{ue\+\_\+cell\+\_\+cfg,  }\item[{\mbox{\hyperlink{classunsigned}{unsigned}}}]{k0,  }\item[{\mbox{\hyperlink{classsrsran_1_1span}{span}}$<$ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classuint8__t}{uint8\+\_\+t}} $>$}]{k1\+\_\+list,  }\item[{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{structsrsran_1_1pdcch__dl__information}{pdcch\+\_\+dl\+\_\+information}} \texorpdfstring{$\ast$}{*}}]{fallback\+\_\+dci\+\_\+info = {\ttfamily \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{nullptr}}} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

Allocate the common PUCCH resource for HARQ-\/\+ACK for a given UE. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em res\+\_\+alloc} & struct with scheduling results. \\
\hline
\mbox{\texttt{ in}}  & {\em crnti} & RNTI of the UE. \\
\hline
\mbox{\texttt{ in}}  & {\em ue\+\_\+cell\+\_\+cfg} & user configuration. For the fallback mode case, this configuration is used to determine whether the slot coincides with a CSI report opportunity; in which case, the allocation of the UCI on common PUCCH resources will be skipped. \\
\hline
\mbox{\texttt{ in}}  & {\em k0} & k0 value, or delay (in slots) of PDSCH slot vs the corresponding PDCCH slot. \\
\hline
\mbox{\texttt{ in}}  & {\em k1\+\_\+list} & List of k1 candidates configured for UE. \\
\hline
\mbox{\texttt{ in}}  & {\em fallback\+\_\+dci\+\_\+info} & pointer to the information with DL DCI, used for scheduling the UCI on common PUCCH resources. If this is not {\ttfamily nullptr}, it triggers the UCI scheduling using common PUCCH resources; else, UCI will be scheduled either on dedicated PUCCH resources or on PUSCH. \\
\hline
\end{DoxyParams}


Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_a674277651ca609ca8e827986589305a3}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00194\ \{}
\DoxyCodeLine{00195\ \ \ \textcolor{comment}{//\ [Implementation-\/defined]\ We\ restrict\ the\ number\ of\ HARQ\ bits\ per\ PUCCH\ that\ are\ expected\ to\ carry\ CSI\ reporting\ to}}
\DoxyCodeLine{00196\ \ \ \textcolor{comment}{//\ 2\ ,\ until\ the\ PUCCH\ allocator\ supports\ more\ than\ this.}}
\DoxyCodeLine{00197\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classuint8__t}{uint8\_t}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{max\_harq\_bits\_per\_uci}}\ =\ 2U;}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classsrsran_1_1slot__point}{slot\_point}}\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pdsch\_slot}}\ =\ res\_alloc[k0].slot;}
\DoxyCodeLine{00200\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classsrsran_1_1cell__configuration}{cell\_configuration}}\&\ cell\_cfg\ \ \ =\ ue\_cell\_cfg.cell\_cfg\_common;}
\DoxyCodeLine{00201\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{min\_pdsch\_to\_ack\_slot\_distance}}\ =}
\DoxyCodeLine{00202\ \ \ \ \ \ \ get\_min\_pdsch\_to\_ack\_slot\_distance(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pdsch\_slot}},}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ crnti,}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *std::min\_element(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_list}}.begin(),\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_list}}.end()),}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *std::max\_element(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_list}}.begin(),\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_list}}.end()));}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classuint8__t}{uint8\_t}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_candidate}}\ :\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_list}})\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{comment}{//\ Step\ 1:\ Check\ for\ validity\ of\ the\ UCI\ slot\ and\ other\ restrictions.}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ Check\ whether\ the\ UCI\ slot\ to\ be\ scheduled\ is\ >=\ last\ UCI\ HARQ\ ACK\ allocated\ slot\ for\ the\ UE.}}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{comment}{//\ NOTE:\ The\ reason\ for\ having\ this\ logic\ is\ due\ to\ fact\ that\ COTS\ UE\ sends\ an\ invalid\ ACK\ bits\ if\ newly\ scheduled}}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{comment}{//\ PDSCH\ has\ its\ UCI\ HARQ\ ACK\ slot\ before\ the\ (in\ time)\ UCI\ HARQ\ ACK\ slot\ of\ the\ previously\ scheduled\ PDSCH.}}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_candidate}}\ <\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{min\_pdsch\_to\_ack\_slot\_distance}})\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00215\ \ \ \ \ \}}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \ \ \textcolor{comment}{//\ Retrieve\ the\ scheduling\ results\ for\ slot\ =\ k0\ +\ k1;}}
\DoxyCodeLine{00218\ \ \ \ \ \mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\_slot\_resource\_allocator}}\&\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}\ =\ res\_alloc[k0\ +\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_candidate}}\ +\ res\_alloc.\mbox{\hyperlink{structsrsran_1_1cell__resource__allocator_a569167b4165a6dcd93b36bc5cee15105}{cfg}}.ntn\_cs\_koffset];}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classsrsran_1_1slot__point}{slot\_point}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_slot}}\ \ \ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot;}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{//\ Check\ whether\ UCI\ slot\ is\ UL\ enabled.}}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{not}}\ cell\_cfg.is\_fully\_ul\_enabled(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_slot}}))\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00224\ \ \ \ \ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordflow}{if}\ (uci\_alloc\_grid[\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot.to\_uint()].ucis.full())\ \{}
\DoxyCodeLine{00227\ \ \ \ \ \ \ logger.info(}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}rnti=\{\}:\ UCI\ allocation\ for\ slot=\{\}\ skipped\ due\ to\ UCI\ cache\ full.\ Attempting\ this\ allocation\ for\ the\ next\ "{}}}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}k1\ candidate,\ if\ any\ k1\ available"{}},}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ crnti,}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot);}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00233\ \ \ \ \ \}}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{keywordflow}{if}\ (csi\_helper::is\_csi\_reporting\_slot(ue\_cell\_cfg.cfg\_dedicated(),\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_slot}}))\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \textcolor{comment}{//\ NOTE:\ This\ is\ only\ to\ avoid\ allocating\ more\ than\ 2\ HARQ\ bits\ in\ PUCCH\ that\ are\ expected\ to\ carry\ CSI\ reporting.}}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ Remove\ this\ when\ the\ PUCCH\ allocator\ handle\ properly\ more\ than\ 2\ HARQ-\/ACK\ bits\ +\ CSI.}}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classsrsran_1_1uci__allocator__impl_a16dcd0eedda8fe1a34f419b1bec7c2f6}{get\_scheduled\_pdsch\_counter\_in\_ue\_uci}}(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}},\ crnti)\ >=\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{max\_harq\_bits\_per\_uci}})\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \}}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{comment}{//\ Step\ 2:\ Try\ to\ allocate\ UCI\ HARQ\ ACK\ for\ UE,\ either\ on\ PUSCH\ or\ PUCCH.}}
\DoxyCodeLine{00244\ \ \ \ \ \mbox{\hyperlink{classsrsran_1_1optional}{optional<uci\_allocation>}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_output}}\ =}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ alloc\_uci\_harq\_ue\_helper(res\_alloc,\ crnti,\ ue\_cell\_cfg,\ k0,\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_candidate}},\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{fallback\_dci\_info}});}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{comment}{//\ Register\ new\ UCI\ allocation\ in\ the\ respective\ grid\ slot\ entry\ and\ derive\ DAI.}}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_output}}.has\_value())\ \{}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \textcolor{keyword}{auto}*\ uci\ =\ get\_uci\_alloc(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot,\ crnti);}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (uci\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ uci\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ \&uci\_alloc\_grid[\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot.to\_uint()].ucis.emplace\_back();}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ uci-\/>rnti\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ crnti;}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ uci-\/>scheduled\_dl\_pdcch\_counter\ =\ 0;}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_output}}.value().harq\_bit\_idx\ =\ uci-\/>scheduled\_dl\_pdcch\_counter;}
\DoxyCodeLine{00256\ \ \ \ \ \ \ ++uci-\/>scheduled\_dl\_pdcch\_counter;}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_output}}.value().k1\ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{k1\_candidate}};}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{uci\_output}};}
\DoxyCodeLine{00260\ \ \ \ \ \}}
\DoxyCodeLine{00261\ \ \ \}}
\DoxyCodeLine{00262\ \ \ \textcolor{keywordflow}{return}\ \{\};}
\DoxyCodeLine{00263\ \}}

\end{DoxyCode}
\Hypertarget{classsrsran_1_1uci__allocator__impl_a16dcd0eedda8fe1a34f419b1bec7c2f6}\label{classsrsran_1_1uci__allocator__impl_a16dcd0eedda8fe1a34f419b1bec7c2f6} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!get\_scheduled\_pdsch\_counter\_in\_ue\_uci@{get\_scheduled\_pdsch\_counter\_in\_ue\_uci}}
\index{get\_scheduled\_pdsch\_counter\_in\_ue\_uci@{get\_scheduled\_pdsch\_counter\_in\_ue\_uci}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{get\_scheduled\_pdsch\_counter\_in\_ue\_uci()}{get\_scheduled\_pdsch\_counter\_in\_ue\_uci()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classuint8__t}{uint8\+\_\+t}} uci\+\_\+allocator\+\_\+impl\+::get\+\_\+scheduled\+\_\+pdsch\+\_\+counter\+\_\+in\+\_\+ue\+\_\+uci (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&}]{slot\+\_\+alloc,  }\item[{\mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}}}]{crnti }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

Get the number of PDSCHs currently scheduled for a given UE UCI. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em slot\+\_\+alloc} & struct with scheduling results. \\
\hline
\mbox{\texttt{ in}}  & {\em crnti} & C-\/\+RNTI of the UE. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns number of PDSCHs scheduled if UCI allocation if found, 0 otherwise. 
\end{DoxyReturn}


Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_a9c7a7c379c79a8815d14d4a0daa17435}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00357\ \{}
\DoxyCodeLine{00358\ \ \ \textcolor{keyword}{auto}*\ uci\ =\ get\_uci\_alloc(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot,\ crnti);}
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{if}\ (uci\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00361\ \ \ \}}
\DoxyCodeLine{00362\ \ \ \textcolor{keywordflow}{return}\ uci-\/>scheduled\_dl\_pdcch\_counter;}
\DoxyCodeLine{00363\ \}}

\end{DoxyCode}
\Hypertarget{classsrsran_1_1uci__allocator__impl_a4fddfb180ae008720176729b6d33e862}\label{classsrsran_1_1uci__allocator__impl_a4fddfb180ae008720176729b6d33e862} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!multiplex\_uci\_on\_pusch@{multiplex\_uci\_on\_pusch}}
\index{multiplex\_uci\_on\_pusch@{multiplex\_uci\_on\_pusch}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{multiplex\_uci\_on\_pusch()}{multiplex\_uci\_on\_pusch()}}
{\footnotesize\ttfamily \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} uci\+\_\+allocator\+\_\+impl\+::multiplex\+\_\+uci\+\_\+on\+\_\+pusch (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\+\_\+sched\+\_\+info}} \&}]{pusch\+\_\+grant,  }\item[{\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&}]{slot\+\_\+alloc,  }\item[{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&}]{ue\+\_\+cell\+\_\+cfg,  }\item[{\mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}}}]{crnti }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

Multiplexes the UCI on PUSCH, by removing the UCI on the PUCCH (if present) and adding it to the PUSCH. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em pusch\+\_\+grant} & struct with PUSCH PDU where UCI need to be allocated. \\
\hline
\mbox{\texttt{ in,out}}  & {\em slot\+\_\+alloc} & struct with scheduling results. \\
\hline
\mbox{\texttt{ in}}  & {\em ue\+\_\+cell\+\_\+cfg} & user configuration. \\
\hline
\mbox{\texttt{ in}}  & {\em crnti} & C-\/\+RNTI of the UE. \\
\hline
\end{DoxyParams}


Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_a7dc8ff45c9cfad1a418ce24f2c06d1ff}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00269\ \{}
\DoxyCodeLine{00270\ \ \ \textcolor{comment}{//\ Move\ the\ bits\ that\ are\ carried\ by\ the\ PUCCH\ into\ the\ PUSCH.}}
\DoxyCodeLine{00271\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structsrsran_1_1pucch__uci__bits}{pucch\_uci\_bits}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}\ =\ pucch\_alloc.\mbox{\hyperlink{classsrsran_1_1pucch__allocator_ac72002185e4401aa842da529b8aa8e3c}{remove\_ue\_uci\_from\_pucch}}(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}},\ crnti,\ ue\_cell\_cfg);}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \ \ \textcolor{comment}{//\ In\ case\ there\ are\ no\ UCI\ bits\ from\ PUCCH,\ then\ there\ is\ no\ UCI\ to\ be\ multiplexed\ on\ the\ PUSCH.}}
\DoxyCodeLine{00274\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}.harq\_ack\_nof\_bits\ ==\ 0\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{and}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}.csi\_part1\_bits\ ==\ 0)\ \{}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00276\ \ \ \}}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \ \ \textcolor{comment}{//\ We\ assume\ that\ at\ this\ point,\ there\ are\ no\ existing\ UCI\ grants\ in\ the\ PUSCH;\ allocate\ a\ new\ one.}}
\DoxyCodeLine{00279\ \ \ \mbox{\hyperlink{structsrsran_1_1uci__info}{uci\_info}}\&\ uci\ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pusch\_grant}}.uci.emplace();}
\DoxyCodeLine{00280\ \ \ uci.\mbox{\hyperlink{structsrsran_1_1uci__info_acc567220ff7b74727a80b923d80abcb5}{alpha}}\ \ \ \ \ =\ ue\_cell\_cfg.cfg\_dedicated().\mbox{\hyperlink{structsrsran_1_1serving__cell__config_a2fe7ab17cda5bafb76bcabb1e526e556}{ul\_config}}.value().init\_ul\_bwp.pusch\_cfg.value().uci\_cfg.value().scaling;}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}.csi\_part1\_bits\ !=\ 0)\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{comment}{//\ The\ number\ of\ bits\ is\ computed\ based\ on\ the\ CSI\ report\ configuration.}}
\DoxyCodeLine{00284\ \ \ \ \ add\_csi\_to\_uci\_on\_pusch(uci.csi.emplace(),\ ue\_cell\_cfg);}
\DoxyCodeLine{00285\ \ \ \}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}.harq\_ack\_nof\_bits\ !=\ 0)\ \{}
\DoxyCodeLine{00288\ \ \ \ \ uci.harq.emplace();}
\DoxyCodeLine{00289\ \ \ \ \ uci.harq.value().harq\_ack\_nof\_bits\ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{pucch\_uci}}.harq\_ack\_nof\_bits;}
\DoxyCodeLine{00290\ \ \ \ \ update\_uci\_on\_pusch\_harq\_offsets(}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ uci.harq.value(),\ ue\_cell\_cfg.cfg\_dedicated().\mbox{\hyperlink{structsrsran_1_1serving__cell__config_a2fe7ab17cda5bafb76bcabb1e526e556}{ul\_config}}.value().init\_ul\_bwp.pusch\_cfg.value().uci\_cfg.value());}
\DoxyCodeLine{00292\ \ \ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ logger.debug(\textcolor{stringliteral}{"{}rnti=\{\}:\ UCI\ mltplxd\ on\ PUSCH\ for\ slot=\{\}"{}},\ crnti,\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.slot);}
\DoxyCodeLine{00295\ \}}

\end{DoxyCode}
\Hypertarget{classsrsran_1_1uci__allocator__impl_a84eb829ee60066ebf2e38f13386e45c8}\label{classsrsran_1_1uci__allocator__impl_a84eb829ee60066ebf2e38f13386e45c8} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!slot\_indication@{slot\_indication}}
\index{slot\_indication@{slot\_indication}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{slot\_indication()}{slot\_indication()}}
{\footnotesize\ttfamily \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} uci\+\_\+allocator\+\_\+impl\+::slot\+\_\+indication (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classsrsran_1_1slot__point}{slot\+\_\+point}}}]{sl\+\_\+tx }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Reset the internal counter of the allocated PDSCHs to be acknowledged per slot. 



Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_afd4f1ff81475ddc02a6af42623a98e60}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00183\ \{}
\DoxyCodeLine{00184\ \ \ \textcolor{comment}{//\ Clear\ previous\ slot\ UCI\ allocations.}}
\DoxyCodeLine{00185\ \ \ uci\_alloc\_grid[(sl\_tx\ -\/\ 1).to\_uint()].ucis.clear();}
\DoxyCodeLine{00186\ \}}

\end{DoxyCode}
\Hypertarget{classsrsran_1_1uci__allocator__impl_a8822e6aa48eadc564e20f040e34e21dd}\label{classsrsran_1_1uci__allocator__impl_a8822e6aa48eadc564e20f040e34e21dd} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!uci\_allocate\_csi\_opportunity@{uci\_allocate\_csi\_opportunity}}
\index{uci\_allocate\_csi\_opportunity@{uci\_allocate\_csi\_opportunity}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{uci\_allocate\_csi\_opportunity()}{uci\_allocate\_csi\_opportunity()}}
{\footnotesize\ttfamily \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} uci\+\_\+allocator\+\_\+impl\+::uci\+\_\+allocate\+\_\+csi\+\_\+opportunity (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&}]{slot\+\_\+alloc,  }\item[{\mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}}}]{crnti,  }\item[{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&}]{ue\+\_\+cell\+\_\+cfg }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

Allocates the CSI opportunities for a given UE. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em slot\+\_\+alloc} & struct with scheduling results. \\
\hline
\mbox{\texttt{ in}}  & {\em crnti} & C-\/\+RNTI of the UE. \\
\hline
\mbox{\texttt{ in}}  & {\em ue\+\_\+cell\+\_\+cfg} & user configuration. \\
\hline
\end{DoxyParams}


Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_a0f84d2218d19858514d4c0ae3617006f}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00321\ \{}
\DoxyCodeLine{00322\ \ \ \textcolor{keyword}{auto}\&\ \ \ \ \ \ \ \ \ \ puschs\ \ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs;}
\DoxyCodeLine{00323\ \ \ \mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\_sched\_info}}*\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}\ =\ std::find\_if(}
\DoxyCodeLine{00324\ \ \ \ \ \ \ puschs.begin(),\ puschs.end(),\ [crnti](\mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\_sched\_info}}\&\ pusch)\ \{\ return\ pusch.pusch\_cfg.rnti\ ==\ crnti;\ \});}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{has\_pusch\_grants}}\ =}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{not}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs.empty()\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{and}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}\ !=\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs.end();}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \ \ \textcolor{comment}{//\ TODO:\ check\ if\ this\ case\ is\ possible.\ The\ first\ PUSCH\ that\ is\ allocated\ outside\ the\ RAR\ grant\ is\ will\ be\ allocated}}
\DoxyCodeLine{00330\ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ after\ the\ UE\ objected\ gets\ created\ with\ the\ UE\ dedicated\ configuration;\ this\ means\ the\ CSI\ scheduler\ should}}
\DoxyCodeLine{00331\ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ start\ allocating\ CSI\ grants\ before\ any\ PUSCH\ grants\ (except\ the\ PUSCH\ scheduled\ in\ the\ RAR).}}
\DoxyCodeLine{00332\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{has\_pusch\_grants}})\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \textcolor{comment}{//\ If\ there\ is\ UCI\ grant\ allocated,\ allocate\ it.}}
\DoxyCodeLine{00334\ \ \ \ \ srsran\_assert(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{not}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.has\_value(),\ \textcolor{stringliteral}{"{}UCI\ on\ PUSCH\ grant\ for\ CSI\ cannot\ be\ already\ allocated"{}});}
\DoxyCodeLine{00335\ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.emplace();}
\DoxyCodeLine{00336\ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.value().alpha\ =}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ ue\_cell\_cfg.cfg\_dedicated().\mbox{\hyperlink{structsrsran_1_1serving__cell__config_a2fe7ab17cda5bafb76bcabb1e526e556}{ul\_config}}.value().init\_ul\_bwp.pusch\_cfg.value().uci\_cfg.value().scaling;}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ \ \ add\_csi\_to\_uci\_on\_pusch(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.value().csi.emplace(),\ ue\_cell\_cfg);}
\DoxyCodeLine{00340\ }
\DoxyCodeLine{00341\ \ \ \ \ logger.debug(\textcolor{stringliteral}{"{}rnti=\{\}\ UCI\ with\ 0\ H-\/ACK,\ \{\}\ CSI-\/p1\ and\ \{\}\ CSI-\/p2\ bits\ for\ slot=\{\}\ allocated\ on\ PUSCH"{}},}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ crnti,}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.value().csi.value().csi\_part1\_nof\_bits,}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}-\/>uci.value().csi.value().beta\_offset\_csi\_2.has\_value()\ ?\ \textcolor{stringliteral}{"{}up\ to\ 11"{}}\ :\ \textcolor{stringliteral}{"{}0"{}},}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.\mbox{\hyperlink{namespacesrsran_a457973e91fb03d0c262578c3bdf460f0a5e97994ed38a2b2f984f3b2b75012bf8}{slot}});}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00347\ \ \ \}}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \textcolor{comment}{//\ Else,\ allocate\ the\ CSI\ on\ the\ PUCCH.}}
\DoxyCodeLine{00350\ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{csi\_report\_cfg}}\ =\ \mbox{\hyperlink{namespacesrsran_a60da9701c9f3803ebd964b4f13f2c545}{create\_csi\_report\_configuration}}(ue\_cell\_cfg.cfg\_dedicated().\mbox{\hyperlink{structsrsran_1_1serving__cell__config_a6cb73c2a0cc5b1478ca90b6535700926}{csi\_meas\_cfg}}.value());}
\DoxyCodeLine{00351\ \ \ pucch\_alloc.\mbox{\hyperlink{classsrsran_1_1pucch__allocator_aaac1e5eeb05f561f15cba9f4e00fd2cd}{pucch\_allocate\_csi\_opportunity}}(}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}},\ crnti,\ ue\_cell\_cfg,\ \mbox{\hyperlink{namespacesrsran_aa54a86e2745b57a02fb20c90a3d48427}{get\_csi\_report\_pucch\_size}}(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{csi\_report\_cfg}}).value());}
\DoxyCodeLine{00353\ \}}

\end{DoxyCode}
\Hypertarget{classsrsran_1_1uci__allocator__impl_adc49dd1f1e934b61b239929608850414}\label{classsrsran_1_1uci__allocator__impl_adc49dd1f1e934b61b239929608850414} 
\index{srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}!uci\_allocate\_sr\_opportunity@{uci\_allocate\_sr\_opportunity}}
\index{uci\_allocate\_sr\_opportunity@{uci\_allocate\_sr\_opportunity}!srsran::uci\_allocator\_impl@{srsran::uci\_allocator\_impl}}
\doxysubsubsection{\texorpdfstring{uci\_allocate\_sr\_opportunity()}{uci\_allocate\_sr\_opportunity()}}
{\footnotesize\ttfamily \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{void}} uci\+\_\+allocator\+\_\+impl\+::uci\+\_\+allocate\+\_\+sr\+\_\+opportunity (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structsrsran_1_1cell__slot__resource__allocator}{cell\+\_\+slot\+\_\+resource\+\_\+allocator}} \&}]{slot\+\_\+alloc,  }\item[{\mbox{\hyperlink{namespacesrsran_a1d83bcd76f2b7c6251855be8472a46f5}{rnti\+\_\+t}}}]{crnti,  }\item[{\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{const}} \mbox{\hyperlink{classsrsran_1_1ue__cell__configuration}{ue\+\_\+cell\+\_\+configuration}} \&}]{ue\+\_\+cell\+\_\+cfg }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

Allocates the SR opportunities for a given UE. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em slot\+\_\+alloc} & struct with scheduling results. \\
\hline
\mbox{\texttt{ in}}  & {\em crnti} & C-\/\+RNTI of the UE. \\
\hline
\mbox{\texttt{ in}}  & {\em ue\+\_\+cell\+\_\+cfg} & user configuration. \\
\hline
\end{DoxyParams}


Implements \mbox{\hyperlink{classsrsran_1_1uci__allocator_a8988a7267faed735f86e43ddc04c70e8}{srsran\+::uci\+\_\+allocator}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00300\ \{}
\DoxyCodeLine{00301\ \ \ \textcolor{comment}{//\ Retrieve\ the\ scheduling\ results\ for\ slot\ =\ k0\ +\ k1;}}
\DoxyCodeLine{00302\ \ \ \textcolor{keyword}{auto}\&\ \ \ \ \ \ \ \ \ \ puschs\ \ \ \ \ \ \ \ \ =\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs;}
\DoxyCodeLine{00303\ \ \ \mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\_sched\_info}}*\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}\ =\ std::find\_if(}
\DoxyCodeLine{00304\ \ \ \ \ \ \ puschs.begin(),\ puschs.end(),\ [crnti](\mbox{\hyperlink{structsrsran_1_1ul__sched__info}{ul\_sched\_info}}\&\ pusch)\ \{\ return\ pusch.pusch\_cfg.rnti\ ==\ crnti;\ \});}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{has\_pusch\_grants}}\ =}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{not}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs.empty()\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{and}}\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{existing\_pusch}}\ !=\ \mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}}.result.ul.puschs.end();}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \textcolor{comment}{//\ If\ there\ is\ a\ PUSCH\ allocated\ for\ this\ UE,\ do\ not\ allocate\ any\ PUCCH\ SR\ grants.}}
\DoxyCodeLine{00310\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{has\_pusch\_grants}})\ \{}
\DoxyCodeLine{00311\ \ \ \ \ logger.debug(\textcolor{stringliteral}{"{}rnti=\{\}:\ SR\ allocation\ skipped\ due\ to\ PUSCH\ grant\ allocated."{}},\ crnti);}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00313\ \ \ \}}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ pucch\_alloc.\mbox{\hyperlink{classsrsran_1_1pucch__allocator_a756012774ab9d566cd8231211c769df9}{pucch\_allocate\_sr\_opportunity}}(\mbox{\hyperlink{namespacesrsran_a58e7c9f2c51a9ad6a0899b46d5315723}{slot\_alloc}},\ crnti,\ ue\_cell\_cfg);}
\DoxyCodeLine{00316\ \}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
lib/scheduler/uci\+\_\+scheduling/uci\+\_\+allocator\+\_\+impl.\+h\item 
lib/scheduler/uci\+\_\+scheduling/uci\+\_\+allocator\+\_\+impl.\+cpp\end{DoxyCompactItemize}
